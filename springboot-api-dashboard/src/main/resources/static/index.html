<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot API ç›‘æ§é¢æ¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .metric-card {
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(59, 130, 246, 0.3);
            border-radius: 50%;
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .sortable {
            cursor: pointer;
            user-select: none;
        }
        .sort-icon {
            display: inline-block;
            margin-left: 0.5rem;
            opacity: 0.5;
        }
        .sort-asc::after {
            content: 'â†‘';
            color: #3b82f6;
            opacity: 1;
        }
        .sort-desc::after {
            content: 'â†“';
            color: #3b82f6;
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8" x-data="metricsApp()">
        <!-- Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ğŸš€ Spring Boot API ç›‘æ§é¢æ¿</h1>
            <p class="text-gray-600">å®æ—¶ç›‘æ§APIæ¥å£æ€§èƒ½æŒ‡æ ‡</p>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="metric-card bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-sm font-bold">API</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">ç›‘æ§æ¥å£æ•°</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="summary.totalMethods"></p>
                    </div>
                </div>
            </div>

            <div class="metric-card bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-sm font-bold">ğŸ“ˆ</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">æ€»è°ƒç”¨æ¬¡æ•°</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="summary.totalCalls.toLocaleString()"></p>
                    </div>
                </div>
            </div>

            <div class="metric-card bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-sm font-bold">âŒ</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">æ€»é”™è¯¯æ¬¡æ•°</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="summary.totalErrors"></p>
                    </div>
                </div>
            </div>

            <div class="metric-card bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center">
                            <span class="text-white text-sm font-bold">â±ï¸</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-500">å¹³å‡å“åº”æ—¶é—´</p>
                        <p class="text-2xl font-semibold text-gray-900" x-text="Math.round(summary.avgResponseTime * 100) / 100 + 'ms'"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <!-- Time Range Filter -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-3">æ—¶é—´èŒƒå›´ç­›é€‰</h4>
                <div class="flex flex-wrap gap-2 mb-3">
                    <button @click="setTimeRange('all')" 
                            :class="timeRange === 'all' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
                            class="px-3 py-1 rounded text-sm transition-colors">
                        å…¨éƒ¨æ—¶é—´
                    </button>
                    <button @click="setTimeRange(5)" 
                            :class="timeRange === 5 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
                            class="px-3 py-1 rounded text-sm transition-colors">
                        æœ€è¿‘5åˆ†é’Ÿ
                    </button>
                    <button @click="setTimeRange(30)" 
                            :class="timeRange === 30 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
                            class="px-3 py-1 rounded text-sm transition-colors">
                        æœ€è¿‘30åˆ†é’Ÿ
                    </button>
                    <button @click="setTimeRange(60)" 
                            :class="timeRange === 60 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
                            class="px-3 py-1 rounded text-sm transition-colors">
                        æœ€è¿‘1å°æ—¶
                    </button>
                    <button @click="setTimeRange(360)" 
                            :class="timeRange === 360 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
                            class="px-3 py-1 rounded text-sm transition-colors">
                        æœ€è¿‘6å°æ—¶
                    </button>
                    <button @click="setTimeRange(1440)" 
                            :class="timeRange === 1440 ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
                            class="px-3 py-1 rounded text-sm transition-colors">
                        æœ€è¿‘24å°æ—¶
                    </button>
                </div>
                
                <!-- Custom Time Range -->
                <div class="flex flex-wrap items-end gap-4" x-show="timeRange === 'custom'">
                    <div class="flex-1 min-w-40">
                        <label class="block text-xs text-gray-600 mb-1">å¼€å§‹æ—¶é—´</label>
                        <input type="datetime-local" 
                               x-model="customStartTime"
                               class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                    </div>
                    <div class="flex-1 min-w-40">
                        <label class="block text-xs text-gray-600 mb-1">ç»“æŸæ—¶é—´</label>
                        <input type="datetime-local" 
                               x-model="customEndTime"
                               class="w-full px-3 py-2 border border-gray-300 rounded text-sm">
                    </div>
                    <button @click="applyCustomTimeRange()" 
                            class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded text-sm transition-colors">
                        åº”ç”¨
                    </button>
                </div>
                
                <button @click="setTimeRange('custom')" 
                        :class="timeRange === 'custom' ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700'"
                        class="px-3 py-1 rounded text-sm transition-colors mt-2">
                    è‡ªå®šä¹‰æ—¶é—´
                </button>
            </div>

            <!-- Search and Controls -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                <div class="flex items-center gap-4 flex-wrap">
                    <!-- Search Box -->
                    <div class="relative">
                        <input type="text" 
                               x-model="methodFilter"
                               @input="debounceSearch()"
                               placeholder="æœç´¢æ¥å£å..."
                               class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <button x-show="methodFilter" 
                                @click="clearSearch()"
                                class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <svg class="h-4 w-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <button 
                        @click="fetchMetrics()"
                        class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center gap-2"
                        :disabled="loading">
                        <span class="loading" x-show="loading"></span>
                        <span x-show="!loading">ğŸ”„</span>
                        åˆ·æ–°æ•°æ®
                    </button>
                    
                    <button 
                        @click="clearMetrics()"
                        class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors">
                        ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®
                    </button>
                    
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600">è‡ªåŠ¨åˆ·æ–°:</label>
                        <input type="checkbox" 
                               x-model="autoRefresh" 
                               @change="toggleAutoRefresh()"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-sm text-gray-600">3ç§’</span>
                    </div>
                </div>
                
                <div class="text-sm text-gray-500">
                    <div>æœ€åæ›´æ–°: <span x-text="lastUpdate"></span></div>
                    <div x-show="timeRangeText" class="text-xs text-blue-600 mt-1" x-text="timeRangeText"></div>
                </div>
            </div>
        </div>

        <!-- Metrics Table -->
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800">æ¥å£è°ƒç”¨è¯¦ç»†ç»Ÿè®¡</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                @click="sortBy('method')">
                                æ¥å£æ–¹æ³•
                                <span class="sort-icon" :class="getSortClass('method')"></span>
                            </th>
                            <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                @click="sortBy('total')">
                                æ€»è°ƒç”¨
                                <span class="sort-icon" :class="getSortClass('total')"></span>
                            </th>
                            <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                @click="sortBy('success')">
                                æˆåŠŸæ¬¡æ•°
                                <span class="sort-icon" :class="getSortClass('success')"></span>
                            </th>
                            <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                @click="sortBy('fail')">
                                å¤±è´¥æ¬¡æ•°
                                <span class="sort-icon" :class="getSortClass('fail')"></span>
                            </th>
                            <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                @click="sortBy('successRate')">
                                æˆåŠŸç‡
                                <span class="sort-icon" :class="getSortClass('successRate')"></span>
                            </th>
                            <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                @click="sortBy('avgTime')">
                                å¹³å‡è€—æ—¶(ms)
                                <span class="sort-icon" :class="getSortClass('avgTime')"></span>
                            </th>
                            <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                @click="sortBy('maxTime')">
                                æœ€å¤§è€—æ—¶(ms)
                                <span class="sort-icon" :class="getSortClass('maxTime')"></span>
                            </th>
                            <th class="sortable px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                @click="sortBy('minTime')">
                                æœ€å°è€—æ—¶(ms)
                                <span class="sort-icon" :class="getSortClass('minTime')"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="item in sortedMetrics" :key="item.method">
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm font-medium text-gray-900" x-text="item.method"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900" x-text="item.total.toLocaleString()"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-green-600 font-medium" x-text="item.success.toLocaleString()"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-red-600 font-medium" x-text="item.fail"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <span class="text-sm font-medium text-gray-900" x-text="item.successRate + '%'"></span>
                                        <div class="ml-2 w-16 bg-gray-200 rounded-full h-2">
                                            <div class="bg-green-500 h-2 rounded-full" 
                                                 :style="`width: ${item.successRate}%`"></div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900" x-text="item.avgTime"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900" x-text="item.maxTime"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="text-sm text-gray-900" x-text="item.minTime"></div>
                                </td>
                            </tr>
                        </template>
                        <tr x-show="sortedMetrics.length === 0 && !loading">
                            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
                                <div class="text-lg mb-2">ğŸ“Š</div>
                                <div>æš‚æ— æ•°æ®ï¼Œè¯·å…ˆè°ƒç”¨ä¸€äº›APIæ¥å£</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-500 text-sm">
            <p>ğŸš€ Spring Boot è½»é‡çº§ APM - æ–¹æ³•çº§æ€§èƒ½ç›‘æ§</p>
        </div>
    </div>

    <script>
        function metricsApp() {
            return {
                metrics: {},
                summary: {
                    totalMethods: 0,
                    totalCalls: 0,
                    totalErrors: 0,
                    avgResponseTime: 0
                },
                loading: false,
                autoRefresh: false,
                refreshInterval: null,
                lastUpdate: '',
                sortField: 'total',
                sortDirection: 'desc',
                
                // æ—¶é—´ç­›é€‰ç›¸å…³
                timeRange: 'all',
                customStartTime: '',
                customEndTime: '',
                timeRangeText: '',
                
                // æœç´¢ç›¸å…³
                methodFilter: '',
                searchTimeout: null,

                async init() {
                    await this.fetchMetrics();
                    await this.fetchSummary();
                    this.initCustomTime();
                },

                initCustomTime() {
                    const now = new Date();
                    const oneHourAgo = new Date(now.getTime() - 60 * 60 * 1000);
                    
                    this.customStartTime = this.formatDateTimeLocal(oneHourAgo);
                    this.customEndTime = this.formatDateTimeLocal(now);
                },

                formatDateTimeLocal(date) {
                    const offset = date.getTimezoneOffset();
                    const adjustedDate = new Date(date.getTime() - (offset * 60 * 1000));
                    return adjustedDate.toISOString().slice(0, 16);
                },

                setTimeRange(range) {
                    this.timeRange = range;
                    this.updateTimeRangeText();
                    if (range !== 'custom') {
                        this.fetchMetrics();
                        this.fetchSummary();
                    }
                },

                updateTimeRangeText() {
                    if (this.timeRange === 'all') {
                        this.timeRangeText = '';
                    } else if (this.timeRange === 'custom') {
                        if (this.customStartTime && this.customEndTime) {
                            const start = new Date(this.customStartTime).toLocaleString();
                            const end = new Date(this.customEndTime).toLocaleString();
                            this.timeRangeText = `æ—¶é—´èŒƒå›´: ${start} - ${end}`;
                        } else {
                            this.timeRangeText = 'è‡ªå®šä¹‰æ—¶é—´èŒƒå›´';
                        }
                    } else {
                        this.timeRangeText = `æœ€è¿‘ ${this.timeRange} åˆ†é’Ÿçš„æ•°æ®`;
                    }
                },

                applyCustomTimeRange() {
                    if (this.customStartTime && this.customEndTime) {
                        this.updateTimeRangeText();
                        this.fetchMetrics();
                        this.fetchSummary();
                    }
                },

                debounceSearch() {
                    if (this.searchTimeout) {
                        clearTimeout(this.searchTimeout);
                    }
                    this.searchTimeout = setTimeout(() => {
                        this.fetchMetrics();
                        this.fetchSummary();
                    }, 500);
                },

                clearSearch() {
                    this.methodFilter = '';
                    this.fetchMetrics();
                    this.fetchSummary();
                },

                buildApiUrl(endpoint) {
                    let url = `/api/metrics${endpoint}`;
                    const params = new URLSearchParams();
                    
                    // æ·»åŠ æ—¶é—´å‚æ•°
                    if (this.timeRange !== 'all') {
                        if (this.timeRange === 'custom') {
                            if (this.customStartTime && this.customEndTime) {
                                params.append('startTime', new Date(this.customStartTime).getTime());
                                params.append('endTime', new Date(this.customEndTime).getTime());
                            }
                        } else {
                            const endTime = Date.now();
                            const startTime = endTime - (this.timeRange * 60 * 1000);
                            params.append('startTime', startTime);
                            params.append('endTime', endTime);
                        }
                    }
                    
                    // æ·»åŠ æœç´¢å‚æ•°
                    if (this.methodFilter.trim()) {
                        params.append('methodFilter', this.methodFilter.trim());
                    }
                    
                    if (params.toString()) {
                        url += '?' + params.toString();
                    }
                    
                    return url;
                },

                async fetchMetrics() {
                    this.loading = true;
                    try {
                        const response = await fetch(this.buildApiUrl(''));
                        this.metrics = await response.json();
                        this.lastUpdate = new Date().toLocaleTimeString();
                    } catch (error) {
                        console.error('Failed to fetch metrics:', error);
                        this.metrics = {};
                    } finally {
                        this.loading = false;
                    }
                },

                async fetchSummary() {
                    try {
                        const response = await fetch(this.buildApiUrl('/summary'));
                        this.summary = await response.json();
                    } catch (error) {
                        console.error('Failed to fetch summary:', error);
                    }
                },

                async clearMetrics() {
                    if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç›‘æ§æ•°æ®å—ï¼Ÿ')) {
                        try {
                            await fetch('/api/metrics', { method: 'DELETE' });
                            await this.fetchMetrics();
                            await this.fetchSummary();
                        } catch (error) {
                            console.error('Failed to clear metrics:', error);
                        }
                    }
                },

                toggleAutoRefresh() {
                    if (this.autoRefresh) {
                        this.refreshInterval = setInterval(async () => {
                            await this.fetchMetrics();
                            await this.fetchSummary();
                        }, 3000);
                    } else {
                        if (this.refreshInterval) {
                            clearInterval(this.refreshInterval);
                            this.refreshInterval = null;
                        }
                    }
                },

                sortBy(field) {
                    if (this.sortField === field) {
                        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortField = field;
                        this.sortDirection = 'desc';
                    }
                },

                getSortClass(field) {
                    if (this.sortField === field) {
                        return this.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc';
                    }
                    return '';
                },

                get sortedMetrics() {
                    const metricsArray = Object.entries(this.metrics).map(([method, data]) => ({
                        method,
                        ...data
                    }));

                    return metricsArray.sort((a, b) => {
                        const aVal = a[this.sortField];
                        const bVal = b[this.sortField];
                        
                        if (this.sortDirection === 'asc') {
                            return aVal > bVal ? 1 : -1;
                        } else {
                            return aVal < bVal ? 1 : -1;
                        }
                    });
                }
            };
        }
    </script>
</body>
</html>