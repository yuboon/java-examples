<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸šåŠ¡åœºæ™¯æ¼”ç¤º - åŠ¨æ€è§„åˆ™å¼•æ“</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        success: '#10B981',
                        error: '#EF4444'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-2xl font-bold text-gray-900">ğŸ›’ è®¢å•å¤„ç†ä¸šåŠ¡æ¼”ç¤º</h1>
                    <nav class="flex space-x-4">
                        <a href="/index.html" class="text-gray-600 hover:text-primary transition-colors">è§„åˆ™ç®¡ç†</a>
                        <a href="/business.html" class="text-primary font-medium border-b-2 border-primary pb-1">ä¸šåŠ¡æ¼”ç¤º</a>
                    </nav>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- ä¸šåŠ¡ä»‹ç» -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">ğŸ’¡ ä¸šåŠ¡åœºæ™¯è¯´æ˜</h2>
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-4">
                    <p class="text-blue-800">
                        <strong>ç”µå•†è®¢å•å¤„ç†æµç¨‹ï¼š</strong> å½“ç”¨æˆ·ä¸‹å•æ—¶ï¼Œç³»ç»Ÿéœ€è¦ä¾æ¬¡æ‰§è¡Œå¤šä¸ªä¸šåŠ¡è§„åˆ™æ¥è®¡ç®—æœ€ç»ˆä»·æ ¼å’Œç§¯åˆ†å¥–åŠ±ã€‚
                        é€šè¿‡åŠ¨æ€è§„åˆ™å¼•æ“ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸é‡å¯åº”ç”¨çš„æƒ…å†µä¸‹è°ƒæ•´è¿™äº›ä¸šåŠ¡é€»è¾‘ã€‚
                    </p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-purple-800 mb-2">1ï¸âƒ£ VIPæŠ˜æ‰£</h3>
                        <p class="text-sm text-purple-700">æ ¹æ®ç”¨æˆ·ç­‰çº§åº”ç”¨ä¸åŒæŠ˜æ‰£ç‡</p>
                    </div>
                    <div class="bg-gradient-to-r from-green-100 to-blue-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-800 mb-2">2ï¸âƒ£ æ»¡å‡æ´»åŠ¨</h3>
                        <p class="text-sm text-green-700">æ»¡è¶³æ¡ä»¶æ—¶è‡ªåŠ¨å‡å…é‡‘é¢</p>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-100 to-orange-100 p-4 rounded-lg">
                        <h3 class="font-semibold text-orange-800 mb-2">3ï¸âƒ£ ç§¯åˆ†å¥–åŠ±</h3>
                        <p class="text-sm text-orange-700">åŸºäºæœ€ç»ˆé‡‘é¢è®¡ç®—ç§¯åˆ†</p>
                    </div>
                </div>
            </div>

            <!-- è®¢å•æ¨¡æ‹Ÿå™¨ -->
            <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-6">ğŸ® è®¢å•æ¨¡æ‹Ÿå™¨</h2>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ç”¨æˆ·ç­‰çº§</label>
                        <select id="userLevel" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="NORMAL">æ™®é€šä¼šå‘˜</option>
                            <option value="SILVER">é“¶ç‰Œä¼šå‘˜</option>
                            <option value="GOLD">é‡‘ç‰Œä¼šå‘˜</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">è®¢å•é‡‘é¢ (å…ƒ)</label>
                        <input type="number" id="orderAmount" value="150" step="0.01"
                               class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>

                    <div class="flex items-end">
                        <button onclick="simulateOrder()"
                                class="w-full bg-primary text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition-colors">
                            ğŸš€ å¤„ç†è®¢å•
                        </button>
                    </div>

                    <div class="flex items-end">
                        <button onclick="clearResults()"
                                class="w-full bg-gray-500 text-white py-3 px-4 rounded-lg hover:bg-gray-600 transition-colors">
                            ğŸ—‘ï¸ æ¸…ç©ºç»“æœ
                        </button>
                    </div>
                </div>
            </div>

            <!-- å¤„ç†ç»“æœå±•ç¤º -->
            <div id="resultsContainer" class="hidden">
                <!-- å¤„ç†æ­¥éª¤ -->
                <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“Š å¤„ç†æ­¥éª¤è¯¦æƒ…</h3>
                    <div id="processingSteps" class="space-y-4">
                        <!-- åŠ¨æ€ç”Ÿæˆæ­¥éª¤ -->
                    </div>
                </div>

                <!-- æœ€ç»ˆç»“æœ -->
                <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg shadow-sm p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ¯ è®¢å•å¤„ç†ç»“æœ</h3>
                    <div id="finalResult" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <!-- åŠ¨æ€ç”Ÿæˆç»“æœ -->
                    </div>
                </div>
            </div>

            <!-- å†å²è®°å½• -->
            <div class="bg-white rounded-lg shadow-sm p-6 mt-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“‹ å¤„ç†å†å²</h3>
                <div id="historyList" class="space-y-3">
                    <div class="text-center text-gray-500 py-4">æš‚æ— å¤„ç†è®°å½•</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let processingHistory = [];

        // æ¨¡æ‹Ÿè®¢å•å¤„ç†
        async function simulateOrder() {
            const userLevel = document.getElementById('userLevel').value;
            const amount = parseFloat(document.getElementById('orderAmount').value);

            if (!amount || amount <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢å•é‡‘é¢', 'error');
                return;
            }

            showLoading(true);

            try {
                const response = await fetch(`/api/orders/simulate?userLevel=${userLevel}&amount=${amount}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const order = await response.json();
                    displayResults(order);
                    addToHistory(order);
                } else {
                    showToast('è®¢å•å¤„ç†å¤±è´¥', 'error');
                }
            } catch (error) {
                showToast('è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }

            showLoading(false);
        }

        // æ˜¾ç¤ºå¤„ç†ç»“æœ
        function displayResults(order) {
            const container = document.getElementById('resultsContainer');
            const stepsContainer = document.getElementById('processingSteps');
            const resultContainer = document.getElementById('finalResult');

            // æ˜¾ç¤ºå¤„ç†æ­¥éª¤
            const originalAmount = parseFloat(order.originalAmount);
            const finalAmount = parseFloat(order.finalAmount);
            const totalSavings = originalAmount - finalAmount;
            const discountRate = ((totalSavings) / originalAmount * 100).toFixed(1);

            // æ¸²æŸ“æ¯ä¸ªå¤„ç†æ­¥éª¤
            const stepHtml = order.processSteps.map((step, index) => {
                const stepNumber = index + 1;
                const beforeAmount = parseFloat(step.beforeAmount);
                const afterAmount = parseFloat(step.afterAmount);
                const reduction = parseFloat(step.reduction);

                let stepColor = 'bg-blue-500';
                if (stepNumber === 2) stepColor = 'bg-green-500';
                if (stepNumber === 3) stepColor = 'bg-purple-500';

                let resultText = '';
                if (reduction > 0) {
                    resultText = `<div class="text-right">
                        <div class="font-semibold text-green-600">Â¥${beforeAmount} â†’ Â¥${afterAmount}</div>
                        <div class="text-sm text-green-500">èŠ‚çœ Â¥${reduction.toFixed(2)}</div>
                    </div>`;
                } else {
                    resultText = `<div class="text-right">
                        <div class="font-semibold text-gray-600">Â¥${beforeAmount}</div>
                        <div class="text-sm text-gray-500">æ— ä¼˜æƒ </div>
                    </div>`;
                }

                return `
                    <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                        <div class="w-8 h-8 ${stepColor} text-white rounded-full flex items-center justify-center font-semibold">${stepNumber}</div>
                        <div class="flex-1">
                            <h4 class="font-medium">${step.stepName}</h4>
                            <p class="text-sm text-gray-600">${step.description}</p>
                        </div>
                        ${resultText}
                    </div>
                `;
            }).join('');

            // æ·»åŠ ç§¯åˆ†å¥–åŠ±æ­¥éª¤
            const pointsStep = `
                <div class="flex items-center space-x-4 p-4 bg-gray-50 rounded-lg">
                    <div class="w-8 h-8 bg-orange-500 text-white rounded-full flex items-center justify-center font-semibold">${order.processSteps.length + 1}</div>
                    <div class="flex-1">
                        <h4 class="font-medium">ç§¯åˆ†å¥–åŠ±</h4>
                        <p class="text-sm text-gray-600">åŸºäºæœ€ç»ˆé‡‘é¢ Â¥${finalAmount} è®¡ç®—ç§¯åˆ†å¥–åŠ±</p>
                    </div>
                    <div class="text-right">
                        <div class="font-semibold text-purple-600">+${order.pointsEarned} ç§¯åˆ†</div>
                        <div class="text-sm text-purple-500">ç§¯åˆ†ç‡ ${(order.pointsEarned / finalAmount * 100).toFixed(1)}%</div>
                    </div>
                </div>
            `;

            stepsContainer.innerHTML = stepHtml + pointsStep;

            // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
            resultContainer.innerHTML = `
                <div class="text-center">
                    <div class="text-2xl font-bold text-gray-900">Â¥${originalAmount}</div>
                    <div class="text-sm text-gray-600">åŸä»·</div>
                </div>

                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600">Â¥${finalAmount}</div>
                    <div class="text-sm text-gray-600">æœ€ç»ˆä»·æ ¼</div>
                </div>

                <div class="text-center">
                    <div class="text-2xl font-bold text-red-500">${discountRate}%</div>
                    <div class="text-sm text-gray-600">æ€»æŠ˜æ‰£ç‡</div>
                </div>

                <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600">${order.pointsEarned}</div>
                    <div class="text-sm text-gray-600">è·å¾—ç§¯åˆ†</div>
                </div>
            `;

            container.classList.remove('hidden');
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(order) {
            processingHistory.unshift(order);
            if (processingHistory.length > 10) {
                processingHistory = processingHistory.slice(0, 10);
            }

            updateHistoryDisplay();
        }

        // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
        function updateHistoryDisplay() {
            const container = document.getElementById('historyList');

            if (processingHistory.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-4">æš‚æ— å¤„ç†è®°å½•</div>';
                return;
            }

            container.innerHTML = processingHistory.map((order, index) => {
                const totalSavings = parseFloat(order.originalAmount) - parseFloat(order.finalAmount);
                const timestamp = new Date(order.createTime).toLocaleString();

                // è®¡ç®—å„æ­¥éª¤çš„è¯¦ç»†ä¿¡æ¯
                let stepDetails = '';
                if (order.processSteps && order.processSteps.length > 0) {
                    const vipStep = order.processSteps[0];
                    const fullReductionStep = order.processSteps[1];

                    const vipSavings = parseFloat(vipStep.reduction || 0);
                    const fullReductionSavings = parseFloat(fullReductionStep.reduction || 0);

                    stepDetails = `VIPæŠ˜æ‰£: -Â¥${vipSavings.toFixed(2)} | æ»¡å‡: -Â¥${fullReductionSavings.toFixed(2)}`;
                } else {
                    stepDetails = 'å¤„ç†è¯¦æƒ…ä¸å¯ç”¨';
                }

                return `
                    <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-4">
                            <div class="w-8 h-8 bg-gray-400 text-white rounded-full flex items-center justify-center text-sm">
                                ${index + 1}
                            </div>
                            <div>
                                <div class="font-medium">${order.orderId}</div>
                                <div class="text-sm text-gray-600">${timestamp}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-medium">${order.userLevel} | Â¥${order.originalAmount} â†’ Â¥${order.finalAmount}</div>
                            <div class="text-sm ${totalSavings > 0 ? 'text-green-600' : 'text-gray-600'}">
                                ${stepDetails} | +${order.pointsEarned}ç§¯åˆ†
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // æ¸…ç©ºç»“æœ
        function clearResults() {
            document.getElementById('resultsContainer').classList.add('hidden');
            processingHistory = [];
            updateHistoryDisplay();
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(show) {
            const button = document.querySelector('button[onclick="simulateOrder()"]');
            if (show) {
                button.disabled = true;
                button.innerHTML = 'ğŸ”„ å¤„ç†ä¸­...';
                button.classList.add('opacity-50');
            } else {
                button.disabled = false;
                button.innerHTML = 'ğŸš€ å¤„ç†è®¢å•';
                button.classList.remove('opacity-50');
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                if (document.body.contains(toast)) {
                    document.body.removeChild(toast);
                }
            }, 3000);
        }
    </script>
</body>
</html>