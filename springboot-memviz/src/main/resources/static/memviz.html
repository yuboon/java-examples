<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>JVM å†…å­˜å¯¹è±¡æ‹“æ‰‘å›¾</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { margin:0; font:14px/1.4 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; background:#0b0f14; color:#e6edf3; }
        header { padding:12px 16px; display:flex; gap:12px; align-items:center; position:sticky; top:0; background:#0b0f14; border-bottom:1px solid #1f2937; z-index:10;}
        header input, header select, header button { padding:6px 10px; background:#111827; color:#e6edf3; border:1px solid #374151; border-radius:8px; }
        header button { cursor:pointer; }
        #panel { width:400px; position:fixed; right:10px; top:70px; bottom:10px; background:#0f172a; border:1px solid #1f2937; border-radius:12px; padding:10px; overflow:auto; }
        #graph { position:absolute; left:0; top:56px; right:420px; bottom:0; }
        .legend { display:flex; gap:8px; align-items:center; }
        .pill { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #334155; }
        .muted { color:#9ca3af; }
        .tab-buttons { display:flex; gap:4px; margin-bottom:12px; }
        .tab-btn { padding:6px 12px; background:#1f2937; border:1px solid #374151; border-radius:6px; cursor:pointer; font-size:12px; }
        .tab-btn.active { background:#3b82f6; color:white; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .top-item { padding:4px 8px; margin:2px 0; background:#1f2937; border-radius:4px; cursor:pointer; font-size:12px; }
        .top-item:hover { background:#374151; }
        .top-rank { display:inline-block; width:20px; color:#6b7280; }
        .stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px; margin-bottom:12px; }
        .stat-item { padding:6px; background:#1f2937; border-radius:4px; text-align:center; }
        .stat-value { font-weight:bold; color:#3b82f6; }
        .detail-row { display:flex; justify-content:space-between; margin:4px 0; padding:2px 0; }
        .detail-label { color:#9ca3af; }
        .detail-value { font-weight:bold; }
        .loading { position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#1f2937; padding:20px; border-radius:8px; border:1px solid #374151; z-index:1000; display:none; }
        .loading-spinner { width:40px; height:40px; border:3px solid #374151; border-top:3px solid #3b82f6; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:999; display:none; }
        /* svg */
        svg { width:100%; height:100%; }
        .link { stroke:#6b7280; stroke-opacity:0.45; }
        .node circle { stroke:#111827; stroke-width:1; cursor:grab; }
        .node text { fill:#d1d5db; font-size:12px; pointer-events:none; }
        .highlight { stroke:#f59e0b !important; stroke-width:2.5 !important; }
    </style>
</head>
<body>

<header>
    <strong>MemViz</strong>
    <button id="btnSnap">ç”Ÿæˆå¿«ç…§</button>
    <label>HPROF æ–‡ä»¶</label><input id="file" size="50" placeholder="/tmp/memviz/heap_*.hprof" />
    <label>ç±»è¿‡æ»¤</label><input id="include" size="30" placeholder="com.myapp.,java.util." value="com.example" />
    <label>æŠ˜å é›†åˆ</label>
    <select id="collapse" title="å°†ArrayListã€HashMapç­‰é›†åˆç±»å‹çš„å¤šä¸ªå…ƒç´ èšåˆæ˜¾ç¤ºï¼Œå‡å°‘å›¾çš„å¤æ‚åº¦">
        <option value="true">æ˜¯ (æ¨è)</option><option value="false">å¦</option>
    </select>
    <button id="btnLoad">åŠ è½½å›¾</button>
</header>

<div id="graph"></div>
<aside id="panel">
    <div class="stat-grid">
        <div class="stat-item">
            <div class="stat-value" id="totalObjects">-</div>
            <div class="muted">æ€»å¯¹è±¡æ•°</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="totalMemory">-</div>
            <div class="muted">æ€»å†…å­˜</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="graphObjects">-</div>
            <div class="muted">å›¾ä¸­å¯¹è±¡</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="graphMemory">-</div>
            <div class="muted">å›¾ä¸­å†…å­˜</div>
        </div>
    </div>
    
    <div class="tab-buttons">
        <div class="tab-btn active" onclick="switchTab('detail')">å¯¹è±¡è¯¦æƒ…</div>
        <div class="tab-btn" onclick="switchTab('top100')">Top100ç±»</div>
        <div class="tab-btn" onclick="switchTab('instances')" style="display:none;">ç±»å®ä¾‹</div>
    </div>
    
    <div id="tab-detail" class="tab-content active">
        <h3>å¯¹è±¡è¯¦æƒ…</h3>
        <div id="info" class="muted">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</div>
        <hr style="border-color:#374151; margin:12px 0;"/>
        <div class="legend">
            <span class="pill" style="background:#1f2937">å›¾ä¾‹è¯´æ˜</span>
            <span class="muted">èŠ‚ç‚¹å¤§å°=å†…å­˜å ç”¨ï¼›é¢œè‰²=ä»£ç ç±»åˆ«</span>
        </div>
    </div>
    
    <div id="tab-top100" class="tab-content">
        <h3>å†…å­˜å ç”¨Top100ç±»</h3>
        <div id="top100-list" class="muted">åŠ è½½å›¾åæ˜¾ç¤º</div>
    </div>
    
    <div id="tab-instances" class="tab-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 id="instances-title">ç±»å®ä¾‹åˆ—è¡¨</h3>
            <button onclick="switchTab('top100')" style="padding:4px 8px; background:#374151; border:1px solid #4b5563; border-radius:4px; color:#e6edf3; font-size:11px; cursor:pointer;">è¿”å›</button>
        </div>
        <div style="font-size:11px; color:#9ca3af; margin-bottom:8px; padding:4px 8px; background:#1f2937; border-radius:4px;">
            ğŸ’¡ æ˜¾ç¤ºè¯¥ç±»ä¸­å†…å­˜å ç”¨æœ€å¤§çš„å®ä¾‹ï¼Œå³ä¾§æ•°å­—è¡¨ç¤ºï¼šå®ä¾‹å¤§å° / åœ¨è¯¥ç±»ä¸­çš„å æ¯”
        </div>
        <div id="instances-list" class="muted">é€‰æ‹©ä¸€ä¸ªç±»æŸ¥çœ‹å…¶å®ä¾‹</div>
    </div>
</aside>

<!-- Loading æç¤º -->
<div id="loading-overlay" class="loading-overlay"></div>
<div id="loading" class="loading">
    <div class="loading-spinner"></div>
    <div style="text-align:center; color:#e6edf3;">æ­£åœ¨è§£æHPROFæ–‡ä»¶...</div>
</div>

<script>
    const qs = s => document.querySelector(s);
    const btnSnap = qs('#btnSnap');
    const btnLoad = qs('#btnLoad');
    let currentData = null;

    // Loadingæ§åˆ¶å‡½æ•°
    function showLoading() {
      qs('#loading-overlay').style.display = 'block';
      qs('#loading').style.display = 'block';
    }

    function hideLoading() {
      qs('#loading-overlay').style.display = 'none';
      qs('#loading').style.display = 'none';
    }

    // æ ‡ç­¾é¡µåˆ‡æ¢
    function switchTab(tabName) {
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
        
        // æ›´æ–°å†…å®¹æ˜¾ç¤º
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    btnSnap.onclick = async () => {
      const resp = await fetch('/memviz/snapshot', { method:'POST' });
      const data = await resp.json();
      qs('#file').value = data.file;
      alert('å¿«ç…§å®Œæˆï¼š' + data.file);
    };

    btnLoad.onclick = async () => {
      const file = qs('#file').value.trim();
      if (!file) return alert('è¯·å¡«å†™ HPROF æ–‡ä»¶è·¯å¾„');
      
      try {
        showLoading();
        const include = encodeURIComponent(qs('#include').value.trim());
        const collapse = qs('#collapse').value;
        const url = `/memviz/graph?file=${encodeURIComponent(file)}&include=${include}&collapseCollections=${collapse}`;
        const data = await fetch(url).then(r => r.json());
        currentData = data;
        window.currentData = data; // ä¿å­˜æ•°æ®ä¾›å…¶ä»–å‡½æ•°ä½¿ç”¨
        renderGraph(data);
        updateStats(data);
        renderTop100(data);
        
        // é‡ç½®ç•Œé¢çŠ¶æ€
        resetUIState();
      } catch (error) {
        alert('åŠ è½½å¤±è´¥: ' + error.message);
      } finally {
        hideLoading();
      }
    };

    function resetUIState() {
      // éšè—å®ä¾‹æ ‡ç­¾é¡µ
      const instancesTab = document.querySelector('.tab-btn[onclick="switchTab(\'instances\')"]');
      instancesTab.style.display = 'none';
      
      // åˆ‡æ¢å›è¯¦æƒ…æ ‡ç­¾é¡µ
      if (document.getElementById('tab-instances').classList.contains('active')) {
        switchTab('detail');
      }
    }

    function updateStats(data) {
      qs('#totalObjects').textContent = data.totalObjects || 0;
      qs('#totalMemory').textContent = data.formattedTotalMemory || '0B';
      
      // è®¡ç®—å›¾ä¸­çš„ç»Ÿè®¡ä¿¡æ¯
      const graphObjects = data.nodes ? data.nodes.length : 0;
      const graphMemoryBytes = data.nodes ? data.nodes.reduce((sum, node) => sum + (node.shallowSize || 0), 0) : 0;
      const graphMemoryFormatted = formatBytes(graphMemoryBytes);
      
      qs('#graphObjects').textContent = graphObjects;
      qs('#graphMemory').textContent = graphMemoryFormatted;
    }

    function renderTop100(data) {
      const container = qs('#top100-list');
      if (!data.top100Classes || data.top100Classes.length === 0) {
        container.innerHTML = '<div class="muted">æš‚æ— æ•°æ®</div>';
        return;
      }
      
      const html = data.top100Classes.map(classStat => `
        <div class="top-item" onclick="selectClassByName('${classStat.className}')">
          <span class="top-rank">#${classStat.rank}</span>
          <strong>${classStat.shortName}</strong>
          <div style="font-size:11px; color:#9ca3af;">
            ${classStat.instanceCount}ä¸ªå®ä¾‹ | æµ…è¡¨: ${classStat.formattedTotalSize} | æ·±åº¦: ${classStat.formattedTotalDeepSize || classStat.formattedTotalSize}
          </div>
          <div style="font-size:10px; color:#6b7280;">
            å¹³å‡æµ…è¡¨: ${classStat.formattedAvgSize} | å¹³å‡æ·±åº¦: ${classStat.formattedAvgDeepSize || classStat.formattedAvgSize}
          </div>
          <div style="font-size:10px; color:#6b7280;">
            ${classStat.category} | ${classStat.packageName}
          </div>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }

    function selectClassByName(className) {
      if (!currentData) return;
      
      // æ‰¾åˆ°è¯¥ç±»çš„ç»Ÿè®¡ä¿¡æ¯
      const classStat = currentData.top100Classes.find(c => c.className === className);
      if (!classStat) return;
      
      // æ˜¾ç¤ºè¯¥ç±»çš„å®ä¾‹åˆ—è¡¨
      showClassInstances(classStat);
      
      // æ‰¾åˆ°è¯¥ç±»çš„æ‰€æœ‰èŠ‚ç‚¹å¹¶é«˜äº®
      const classNodes = currentData.nodes.filter(n => n.className === className);
      if (classNodes.length > 0) {
        // æ˜¾ç¤ºç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯ï¼ˆä»£è¡¨è¿™ä¸ªç±»ï¼‰
        showInfo(classNodes[0]);
        
        // åœ¨SVGä¸­é«˜äº®æ‰€æœ‰è¯¥ç±»çš„èŠ‚ç‚¹
        const svgNodes = document.querySelectorAll('.node');
        svgNodes.forEach(n => n.querySelector('circle').classList.remove('highlight'));
        
        classNodes.forEach(nodeData => {
          const targetNode = Array.from(svgNodes).find(n => {
            const svgNodeData = d3.select(n).datum();
            return svgNodeData && svgNodeData.id === nodeData.id;
          });
          
          if (targetNode) {
            targetNode.querySelector('circle').classList.add('highlight');
          }
        });
      }
    }

    function showClassInstances(classStat) {
      // æ˜¾ç¤ºå®ä¾‹æ ‡ç­¾é¡µæŒ‰é’®
      const instancesTab = document.querySelector('.tab-btn[onclick="switchTab(\'instances\')"]');
      instancesTab.style.display = 'block';
      
      // åˆ‡æ¢åˆ°å®ä¾‹æ ‡ç­¾é¡µ
      switchTab('instances');
      
      // æ›´æ–°æ ‡é¢˜
      qs('#instances-title').textContent = `${classStat.shortName} (${classStat.instanceCount}ä¸ªå®ä¾‹)`;
      
      // æ¸²æŸ“å®ä¾‹åˆ—è¡¨
      const container = qs('#instances-list');
      if (!classStat.topInstances || classStat.topInstances.length === 0) {
        container.innerHTML = '<div class="muted">è¯¥ç±»æš‚æ— å®ä¾‹æ•°æ®</div>';
        return;
      }
      
      const html = classStat.topInstances.map(instance => `
        <div class="top-item" onclick="selectInstanceById('${instance.id}')">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
              <span class="top-rank">#${instance.rank}</span>
              <strong>å¯¹è±¡@${instance.id.slice(-8)}</strong>
              <div style="font-size:9px; color:#6b7280; margin-top:1px;">ID: ${instance.id}</div>
            </div>
            <div style="text-align:right;">
              <div style="font-weight:bold; color:#3b82f6;">${instance.formattedSize}</div>
              <div style="font-size:10px; color:#9ca3af;">${instance.sizePercentInClass.toFixed(1)}%</div>
            </div>
          </div>
          <div style="font-size:11px; color:#9ca3af; margin-top:4px;">
            ${instance.objectType}${instance.isArray ? ' (æ•°ç»„)' : ''} | ${instance.packageName}
          </div>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }

    function selectInstanceById(instanceId) {
      if (!currentData) return;
      
      // æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹
      const node = currentData.nodes.find(n => n.id === instanceId);
      if (node) {
        // æ˜¾ç¤ºè¯¦æƒ…ä¿¡æ¯
        showInfo(node);
        
        // åœ¨SVGä¸­é«˜äº®è¯¥èŠ‚ç‚¹
        const svgNodes = document.querySelectorAll('.node');
        svgNodes.forEach(n => n.querySelector('circle').classList.remove('highlight'));
        
        const targetNode = Array.from(svgNodes).find(n => {
          const nodeData = d3.select(n).datum();
          return nodeData && nodeData.id === instanceId;
        });
        
        if (targetNode) {
          targetNode.querySelector('circle').classList.add('highlight');
        }
        
        // åˆ‡æ¢åˆ°è¯¦æƒ…æ ‡ç­¾é¡µæ˜¾ç¤ºå…·ä½“ä¿¡æ¯
        switchTab('detail');
      }
    }

    function renderGraph(data) {
      const root = qs('#graph');
      root.innerHTML = '';
      const rect = root.getBoundingClientRect();
      const width = rect.width || window.innerWidth - 440;
      const height = window.innerHeight - 60;

      const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
      root.appendChild(svg);

      // é¢œè‰²æ˜ å°„ - æ›´æ–°é¢œè‰²ç­–ç•¥
      const color = (cat) => {
        if (cat === 'JDKç±»') return '#60a5fa';
        if (cat === 'ç¬¬ä¸‰æ–¹') return '#a78bfa'; 
        if (cat === 'ä¸šåŠ¡ä»£ç ') return '#34d399';
        return '#6b7280';
      };

      // åŠ›å¯¼å‘
      const nodes = data.nodes.map(d => Object.assign({}, d));
      const links = data.links.map(l => Object.assign({}, l));

      const sim = d3.forceSimulation(nodes)
          .force('link', d3.forceLink(links).id(d => d.id).distance(80).strength(0.4))
          .force('charge', d3.forceManyBody().strength(-120))
          .force('center', d3.forceCenter(width/2, height/2));

      // zoom/pan
      const g = d3.select(svg).append('g');
      d3.select(svg).call(d3.zoom().scaleExtent([0.1, 4]).on('zoom', (ev) => g.attr('transform', ev.transform)));

      const link = g.selectAll('.link')
          .data(links).enter()
          .append('line')
          .attr('class', 'link');

      const node = g.selectAll('.node')
          .data(nodes).enter()
          .append('g').attr('class','node')
          .call(d3.drag()
            .on('start', (ev, d) => { if (!ev.active) sim.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
            .on('drag', (ev, d) => { d.fx = ev.x; d.fy = ev.y; })
            .on('end',  (ev, d) => { if (!ev.active) sim.alphaTarget(0); /* ä¿æŒå›ºå®šä½ç½®ï¼Œä¸é‡ç½®fxå’Œfy */ }));

      node.append('circle')
          .attr('r', d => Math.max(5, Math.min(30, Math.sqrt(d.shallowSize))))
          .attr('fill', d => color(d.category))
          .on('click', (ev, d) => showInfo(d));

      node.append('text')
          .attr('dy', -10)
          .attr('text-anchor','middle')
          .text(d => d.label); // æ˜¾ç¤ºå®Œæ•´æ ‡ç­¾ä¿¡æ¯

      sim.on('tick', () => {
        link
          .attr('x1', d => d.source.x).attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x).attr('y2', d => d.target.y);
        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });

      function showInfo(d) {
        // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
        document.querySelectorAll('.node circle').forEach(circle => circle.classList.remove('highlight'));
        // æ·»åŠ å½“å‰é«˜äº®
        event.target.classList.add('highlight');
        
        // æŸ¥æ‰¾å¯¹åº”çš„ç±»ç»Ÿè®¡ä¿¡æ¯
        let classStat = null;
        if (window.currentData && window.currentData.top100Classes) {
          classStat = window.currentData.top100Classes.find(cls => cls.className === d.className);
        }
        
        let instancesHtml = '';
        if (classStat && classStat.topInstances && classStat.topInstances.length > 0) {
          instancesHtml = `
            <hr style="border-color:#374151; margin:8px 0;"/>
            <h4>Top ${Math.min(100, classStat.topInstances.length)} å®ä¾‹å¯¹è±¡ <span style="font-size:12px; color:#9ca3af;">(ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…)</span></h4>
            <div style="max-height:300px; overflow-y:auto;">
              <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead>
                  <tr style="border-bottom:1px solid #374151;">
                    <th style="text-align:left; padding:4px;">æ’å</th>
                    <th style="text-align:left; padding:4px;">å¯¹è±¡ID</th>
                    <th style="text-align:right; padding:4px;">æµ…è¡¨å¤§å°</th>
                    <th style="text-align:right; padding:4px;">æ·±åº¦å¤§å°</th>
                    <th style="text-align:right; padding:4px;">å æ¯”</th>
                    <th style="text-align:left; padding:4px;">ç±»å‹</th>
                  </tr>
                </thead>
                <tbody>
                  ${classStat.topInstances.map((instance, index) => `
                    <tr style="border-bottom:1px solid #1f2937; cursor:pointer;" 
                        onclick="showInstanceDetails('${instance.id}', '${d.className}')" 
                        onmouseover="this.style.backgroundColor='#374151'" 
                        onmouseout="this.style.backgroundColor='transparent'">
                      <td style="padding:4px;">#${instance.rank}</td>
                      <td style="padding:4px; color:#60a5fa;">${instance.id}</td>
                      <td style="padding:4px; text-align:right;">${instance.formattedSize}</td>
                      <td style="padding:4px; text-align:right;">${instance.formattedRetainedSize}</td>
                      <td style="padding:4px; text-align:right;">${instance.sizePercentInClass.toFixed(1)}%</td>
                      <td style="padding:4px;">${instance.objectType}${instance.isArray ? ' (æ•°ç»„)' : ''}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
        
        let propertiesHtml = '';
        if (d.fields && d.fields.length > 0) {
          propertiesHtml = `
            <hr style="border-color:#374151; margin:8px 0;"/>
            <h4>ä»£è¡¨æ€§å®ä¾‹å±æ€§åˆ†æ</h4>
            <div style="max-height:200px; overflow-y:auto;">
              <table style="width:100%; border-collapse:collapse; font-size:12px;">
                <thead>
                  <tr style="border-bottom:1px solid #374151;">
                    <th style="text-align:left; padding:4px;">å­—æ®µå</th>
                    <th style="text-align:left; padding:4px;">ç±»å‹</th>
                    <th style="text-align:right; padding:4px;">å¤§å°</th>
                    <th style="text-align:right; padding:4px;">å æ¯”</th>
                    <th style="text-align:left; padding:4px;">å€¼</th>
                  </tr>
                </thead>
                <tbody>
                  ${d.fields.map(field => `
                    <tr style="border-bottom:1px solid #1f2937;">
                      <td style="padding:4px;">${field.name}</td>
                      <td style="padding:4px; color:#9ca3af;">${field.type}</td>
                      <td style="padding:4px; text-align:right;">${field.formattedSize}</td>
                      <td style="padding:4px; text-align:right;">${Math.round(field.sizePercent * 100)}%</td>
                      <td style="padding:4px; overflow:hidden; text-overflow:ellipsis; max-width:150px;">${field.value}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
        
        qs('#info').innerHTML = `
          <div class="detail-row">
            <span class="detail-label">å¯¹è±¡ID:</span>
            <span class="detail-value">${d.id}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ç±»å:</span>
            <span class="detail-value">${d.className}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">æµ…è¡¨å¤§å°:</span>
            <span class="detail-value">${classStat ? classStat.formattedTotalSize : (d.formattedSize || formatBytes(d.shallowSize))}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">æ·±åº¦å¤§å°:</span>
            <span class="detail-value">${classStat ? classStat.formattedTotalDeepSize : (d.formattedDeepSize || formatBytes(d.deepSize || d.shallowSize))}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ç±»åˆ«:</span>
            <span class="detail-value">${d.category}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">å®ä¾‹æ•°é‡:</span>
            <span class="detail-value">${d.instanceCount}ä¸ª</span>
          </div>
          ${instancesHtml}
          ${propertiesHtml}
          </div>
          <div class="detail-row">
            <span class="detail-label">ä»£ç ç±»å‹:</span>
            <span class="detail-value">${d.category}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">åŒ…å:</span>
            <span class="detail-value">${d.packageName || 'æœªçŸ¥'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">å¯¹è±¡ç±»å‹:</span>
            <span class="detail-value">${d.objectType || 'æ™®é€šç±»'}${d.isArray ? ' (æ•°ç»„)' : ''}</span>
          </div>
          <hr style="border-color:#374151; margin:8px 0;"/>
          <div class="muted" style="font-size:11px;">æç¤ºï¼šè¿çº¿ä¸Šçš„å­—æ®µä¿¡æ¯å¯é€šè¿‡é¼ æ ‡æ‚¬åœæŸ¥çœ‹</div>
        `;
      }

      // ç»™æ¯æ¡è¾¹åŠ ä¸Š titleï¼ˆå­—æ®µåï¼‰
      g.selectAll('.link').append('title').text(l => l.field || '');
      
      // æ˜¾ç¤ºå®ä¾‹è¯¦ç»†ä¿¡æ¯çš„å‡½æ•°
      window.showInstanceDetails = function(instanceId, className) {
        if (!window.currentData || !window.currentData.top100Classes) {
          console.error('æ•°æ®æœªåŠ è½½');
          return;
        }
        
        // æŸ¥æ‰¾ç±»ç»Ÿè®¡ä¿¡æ¯
        const classStat = window.currentData.top100Classes.find(cls => cls.className === className);
        if (!classStat || !classStat.topInstances) {
          console.error('æœªæ‰¾åˆ°ç±»ä¿¡æ¯:', className);
          return;
        }
        
        // æŸ¥æ‰¾å…·ä½“å®ä¾‹
        const instance = classStat.topInstances.find(inst => inst.id === instanceId);
        if (!instance) {
          console.error('æœªæ‰¾åˆ°å®ä¾‹:', instanceId);
          return;
        }
        
        // ç”Ÿæˆå®ä¾‹å±æ€§åˆ†æHTML
        let fieldsHtml = '';
        if (instance.fields && instance.fields.length > 0) {
          fieldsHtml = `
            <hr style="border-color:#374151; margin:8px 0;"/>
            <h4>å¯¹è±¡å±æ€§è¯¦ç»†åˆ†æ</h4>
            <div style="max-height:400px; overflow-y:auto; overflow-x:auto;">
              <table style="width:100%; border-collapse:collapse; font-size:12px; table-layout:fixed;">
                <thead>
                  <tr style="border-bottom:1px solid #374151;">
                    <th style="text-align:left; padding:4px; width:15%;">å­—æ®µå</th>
                    <th style="text-align:left; padding:4px; width:15%;">ç±»å‹</th>
                    <th style="text-align:right; padding:4px; width:10%;">æµ…è¡¨å¤§å°</th>
                    <th style="text-align:right; padding:4px; width:10%;">æ·±åº¦å¤§å°</th>
                    <th style="text-align:right; padding:4px; width:8%;">å æ¯”</th>
                    <th style="text-align:left; padding:4px; width:42%;">å€¼</th>
                  </tr>
                </thead>
                <tbody>
                  ${instance.fields.map(field => `
                    <tr style="border-bottom:1px solid #1f2937;">
                      <td style="padding:4px; width:15%; word-wrap:break-word; word-break:break-all;" title="${field.name}">${field.name}</td>
                      <td style="padding:4px; width:15%; color:#9ca3af; word-wrap:break-word; word-break:break-all;" title="${field.type}">${field.type}</td>
                      <td style="padding:4px; width:10%; text-align:right;">${field.formattedSize}</td>
                      <td style="padding:4px; width:10%; text-align:right; color:#10b981;">${field.formattedRetainedSize || field.formattedSize}</td>
                      <td style="padding:4px; width:8%; text-align:right;">${(field.retainedSizePercent || field.sizePercent).toFixed(1)}%</td>
                      <td style="padding:4px; width:42%; word-wrap:break-word; word-break:break-all;" title="${field.value}">${field.value}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        } else {
          fieldsHtml = `
            <hr style="border-color:#374151; margin:8px 0;"/>
            <div style="color:#9ca3af; font-style:italic;">è¯¥å®ä¾‹æ²¡æœ‰å¯åˆ†æçš„å­—æ®µä¿¡æ¯</div>
          `;
        }
        
        // æ˜¾ç¤ºå®ä¾‹è¯¦ç»†ä¿¡æ¯
        qs('#info').innerHTML = `
          <div style="margin-bottom:10px;">
            <button onclick="showClassInfo('${className}')" style="background:#374151; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px;">
              â† è¿”å›ç±»ä¿¡æ¯
            </button>
          </div>
          <div class="detail-row">
            <span class="detail-label">å®ä¾‹ID:</span>
            <span class="detail-value">${instance.id}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">æ‰€å±ç±»:</span>
            <span class="detail-value">${className}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">æµ…è¡¨å¤§å°:</span>
            <span class="detail-value">${instance.formattedSize}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">æ·±åº¦å¤§å°:</span>
            <span class="detail-value">${instance.formattedRetainedSize}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ç±»å†…æ’å:</span>
            <span class="detail-value">#${instance.rank}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ç±»å†…å æ¯”:</span>
            <span class="detail-value">${instance.sizePercentInClass.toFixed(2)}%</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">å¯¹è±¡ç±»å‹:</span>
            <span class="detail-value">${instance.objectType}${instance.isArray ? ' (æ•°ç»„)' : ''}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">åŒ…å:</span>
            <span class="detail-value">${instance.packageName || 'æœªçŸ¥'}</span>
          </div>
          ${fieldsHtml}
          <hr style="border-color:#374151; margin:8px 0;"/>
          <div class="muted" style="font-size:11px;">æç¤ºï¼šè¿™æ˜¯è¯¥å®ä¾‹çš„è¯¦ç»†å±æ€§åˆ†æ</div>
        `;
      };
      
      // è¿”å›ç±»ä¿¡æ¯çš„å‡½æ•°
      window.showClassInfo = function(className) {
        if (!window.currentData || !window.currentData.nodes) {
          console.error('æ•°æ®æœªåŠ è½½');
          return;
        }
        
        // æŸ¥æ‰¾å¯¹åº”çš„èŠ‚ç‚¹
        const node = window.currentData.nodes.find(n => n.className === className);
        if (node) {
          showInfo(node);
        }
      };
    }
    
    function formatBytes(bytes) {
      if (bytes < 1024) return bytes + 'B';
      if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + 'KB';
      if (bytes < 1024*1024*1024) return (bytes/(1024*1024)).toFixed(2) + 'MB';
      return (bytes/(1024*1024*1024)).toFixed(2) + 'GB';
    }
</script>
<!-- ä»…æœ¬é¡µä½¿ç”¨ï¼šD3 from CDN -->
<script src="https://d3js.org/d3.v7.min.js"></script>
</body>
</html>