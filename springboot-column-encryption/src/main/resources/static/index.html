<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spring Boot å­—æ®µçº§åŠ å¯†æ¼”ç¤º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg sticky top-0 z-50 border-b border-gray-100">
        <div class="max-w-full px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex items-center">
                        <i class="fas fa-shield-alt text-indigo-600 text-xl mr-3"></i>
                        <h1 class="text-lg font-bold text-gray-900">Spring Boot å­—æ®µçº§åŠ å¯†æ¼”ç¤º</h1>
                    </div>
                    <div class="hidden sm:flex ml-6 items-center space-x-4">
                        <span class="text-sm text-gray-500 bg-indigo-50 px-2 py-1 rounded-full">@Encrypted æ³¨è§£</span>
                        <span class="text-sm text-gray-500 bg-green-50 px-2 py-1 rounded-full">é€æ˜åŠ è§£å¯†</span>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div id="connectionStatus" class="flex items-center bg-gray-50 px-3 py-2 rounded-lg">
                        <div class="w-2 h-2 bg-gray-400 rounded-full mr-2" id="statusDot"></div>
                        <span class="text-xs text-gray-600" id="statusText">æ£€æŸ¥ä¸­...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="max-w-full px-4 sm:px-6 lg:px-8 py-8">
        <!-- ç³»ç»Ÿä¿¡æ¯å¡ç‰‡ -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8 fade-in">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">ç³»ç»Ÿç‰¹æ€§</h2>
                    <div id="systemInfo" class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm text-gray-600">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span>è‡ªåŠ¨å­—æ®µåŠ å¯†</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span>é€æ˜åŠ è§£å¯†</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span>AES-GCM åŠ å¯†</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span>é›¶ä»£ç ä¾µå…¥</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span>MyBatis é›†æˆ</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-2"></i>
                            <span>å¯çƒ­æ›´æ–°å¯†é’¥</span>
                        </div>
                    </div>
                </div>
                <button onclick="loadStats()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-200">
                    <i class="fas fa-chart-bar mr-2"></i>åˆ·æ–°ç»Ÿè®¡
                </button>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div id="statsContainer" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- ç»Ÿè®¡å¡ç‰‡å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
        </div>

        <!-- æ“ä½œåŒºåŸŸ -->
        <div class="grid grid-cols-1 xl:grid-cols-4 gap-6">
            <!-- å·¦ä¾§ï¼šæ·»åŠ ç”¨æˆ·è¡¨å• -->
            <div class="xl:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6 sticky top-20">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-user-plus text-indigo-600 mr-2"></i>æ·»åŠ ç”¨æˆ·
                    </h3>
                    <form id="addUserForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å *</label>
                            <input type="text" name="username" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                æ‰‹æœºå· * <i class="fas fa-lock text-xs text-gray-400" title="æ­¤å­—æ®µå°†è¢«åŠ å¯†å­˜å‚¨"></i>
                            </label>
                            <input type="tel" name="phone" required pattern="^1[3-9]\d{9}$"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                èº«ä»½è¯å· <i class="fas fa-lock text-xs text-gray-400" title="æ­¤å­—æ®µå°†è¢«åŠ å¯†å­˜å‚¨"></i>
                            </label>
                            <input type="text" name="idCard"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                é‚®ç®± <i class="fas fa-lock text-xs text-gray-400" title="æ­¤å­—æ®µå°†è¢«åŠ å¯†å­˜å‚¨"></i>
                            </label>
                            <input type="email" name="email"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                é“¶è¡Œå¡å· <i class="fas fa-lock text-xs text-gray-400" title="æ­¤å­—æ®µå°†è¢«åŠ å¯†å­˜å‚¨"></i>
                            </label>
                            <input type="text" name="bankCard" pattern="\d{16,19}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                å®¶åº­ä½å€ <i class="fas fa-lock text-xs text-gray-400" title="æ­¤å­—æ®µå°†è¢«åŠ å¯†å­˜å‚¨"></i>
                            </label>
                            <textarea name="address" rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">å¹´é¾„</label>
                                <input type="number" name="age" min="1" max="120"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ«</label>
                                <select name="gender"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="ç”·">ç”·</option>
                                    <option value="å¥³">å¥³</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">èŒä¸š</label>
                            <input type="text" name="occupation"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¤‡æ³¨</label>
                            <textarea name="remark" rows="2"
                                      class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                        </div>
                        <button type="submit"
                                class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-200 flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i>æ·»åŠ ç”¨æˆ·
                        </button>
                    </form>
                </div>

                <!-- æ‰¹é‡æ·»åŠ ç¤ºä¾‹æ•°æ® -->
                <div class="bg-white rounded-xl shadow-md p-6 mt-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-users text-indigo-600 mr-2"></i>æ‰¹é‡æ·»åŠ ç¤ºä¾‹æ•°æ®
                    </h3>
                    <button onclick="addSampleUsers()"
                            class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-200 flex items-center justify-center">
                        <i class="fas fa-database mr-2"></i>ç”Ÿæˆç¤ºä¾‹ç”¨æˆ·
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç”¨æˆ·åˆ—è¡¨ -->
            <div class="xl:col-span-3">
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">
                            <i class="fas fa-list text-indigo-600 mr-2"></i>ç”¨æˆ·åˆ—è¡¨
                        </h3>
                        <div class="flex space-x-2">
                            <input type="text" id="searchInput" placeholder="æœç´¢ç”¨æˆ·å..."
                                   class="px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button onclick="loadUsers()"
                                    class="bg-gray-100 text-gray-700 px-3 py-2 rounded-md hover:bg-gray-200 transition duration-200">
                                <i class="fas fa-search"></i>
                            </button>
                            <button onclick="loadUsers()"
                                    class="bg-indigo-100 text-indigo-700 px-3 py-2 rounded-md hover:bg-indigo-200 transition duration-200">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ç”¨æˆ·è¡¨æ ¼ -->
                    <div class="overflow-x-auto -mx-4 px-4">
                        <table class="w-full divide-y divide-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">ç”¨æˆ·</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">è”ç³»æ–¹å¼</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">ä¸ªäººä¿¡æ¯</th>
                                    <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">çŠ¶æ€</th>
                                    <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody" class="bg-white divide-y divide-gray-100">
                                <!-- ç”¨æˆ·æ•°æ®å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                            </tbody>
                        </table>
                        <div id="emptyState" class="text-center py-12 hidden">
                            <i class="fas fa-users text-gray-300 text-5xl mb-4"></i>
                            <p class="text-gray-500">æš‚æ— ç”¨æˆ·æ•°æ®</p>
                            <p class="text-gray-400 text-sm mt-2">æ·»åŠ ç”¨æˆ·å¼€å§‹ä½“éªŒå­—æ®µçº§åŠ å¯†åŠŸèƒ½</p>
                        </div>
                    </div>

                    <!-- åˆ†é¡µ -->
                    <div id="pagination" class="flex justify-between items-center mt-6">
                        <!-- åˆ†é¡µæ§ä»¶å°†é€šè¿‡ JavaScript åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- åŠ å¯†æ¼”ç¤ºåŒºåŸŸ -->
        <div class="bg-white rounded-xl shadow-md p-6 mt-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-eye text-indigo-600 mr-2"></i>åŠ å¯†æ•ˆæœæ¼”ç¤º
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">ğŸ” åŠ å¯†å­—æ®µï¼ˆå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼‰</h4>
                    <div id="encryptedData" class="bg-gray-50 p-4 rounded-lg font-mono text-sm text-gray-600 h-32 overflow-y-auto">
                        <p class="text-gray-400">æ·»åŠ ç”¨æˆ·åï¼Œè¿™é‡Œå°†æ˜¾ç¤ºå®é™…çš„åŠ å¯†æ•°æ®...</p>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium text-gray-700 mb-2">ğŸ”“ è§£å¯†å­—æ®µï¼ˆåº”ç”¨ä¸­æ˜¾ç¤ºï¼‰</h4>
                    <div id="decryptedData" class="bg-green-50 p-4 rounded-lg font-mono text-sm text-gray-600 h-32 overflow-y-auto">
                        <p class="text-gray-400">åº”ç”¨å±‚è‡ªåŠ¨è§£å¯†ï¼Œä¸šåŠ¡ä»£ç æ— æ„ŸçŸ¥...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast é€šçŸ¥å®¹å™¨ -->
    <div id="toastContainer" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <!-- JavaScript -->
    <script>
        // å…¨å±€å˜é‡
        const API_BASE = '/api/users';
        let currentPage = 1;
        let pageSize = 10;
        let currentUsers = [];

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkConnection();
            loadStats();
            loadUsers();

            // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);

            // ç»‘å®šæœç´¢æ¡†å›è½¦äº‹ä»¶
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadUsers();
                }
            });
        });

        // æ£€æŸ¥åç«¯è¿æ¥çŠ¶æ€
        async function checkConnection() {
            try {
                const response = await fetch(`${API_BASE}/info`);
                if (response.ok) {
                    updateConnectionStatus(true);
                } else {
                    updateConnectionStatus(false);
                }
            } catch (error) {
                updateConnectionStatus(false);
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€æ˜¾ç¤º
        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (connected) {
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full mr-2';
                statusText.textContent = 'å·²è¿æ¥';
            } else {
                statusDot.className = 'w-2 h-2 bg-red-500 rounded-full mr-2';
                statusText.textContent = 'è¿æ¥å¤±è´¥';
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/stats`);
                const result = await response.json();

                if (result.success) {
                    const stats = result.data;
                    const statsContainer = document.getElementById('statsContainer');
                    statsContainer.innerHTML = `
                        <div class="bg-white rounded-lg shadow p-6 slide-up">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-indigo-100 rounded-lg p-3">
                                    <i class="fas fa-users text-indigo-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">æ€»ç”¨æˆ·æ•°</p>
                                    <p class="text-2xl font-semibold text-gray-900">${stats.totalCount}</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 slide-up" style="animation-delay: 0.1s">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-green-100 rounded-lg p-3">
                                    <i class="fas fa-user-check text-green-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">å¯ç”¨ç”¨æˆ·</p>
                                    <p class="text-2xl font-semibold text-gray-900">${stats.enabledCount}</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 slide-up" style="animation-delay: 0.2s">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-yellow-100 rounded-lg p-3">
                                    <i class="fas fa-user-times text-yellow-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">ç¦ç”¨ç”¨æˆ·</p>
                                    <p class="text-2xl font-semibold text-gray-900">${stats.disabledCount}</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-6 slide-up" style="animation-delay: 0.3s">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 bg-purple-100 rounded-lg p-3">
                                    <i class="fas fa-percentage text-purple-600 text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-600">å¯ç”¨ç‡</p>
                                    <p class="text-2xl font-semibold text-gray-900">${stats.enabledRate.toFixed(1)}%</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers(page = 1) {
            try {
                const searchTerm = document.getElementById('searchInput').value;
                let url;

                if (searchTerm) {
                    // æœ‰æœç´¢è¯æ—¶ä½¿ç”¨æœç´¢æ¥å£
                    url = `${API_BASE}/search?username=${searchTerm}&page=${page}&size=${pageSize}`;
                } else {
                    // æ— æœç´¢è¯æ—¶ä½¿ç”¨åˆ†é¡µæ¥å£
                    url = `${API_BASE}/page?page=${page}&size=${pageSize}`;
                }

                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    currentUsers = result.data.content || result.data;
                    renderUserTable(result.data);
                    currentPage = page;
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
                showToast('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
            }
        }

        // æ¸²æŸ“ç”¨æˆ·è¡¨æ ¼
        function renderUserTable(data) {
            const tbody = document.getElementById('userTableBody');
            const emptyState = document.getElementById('emptyState');

            if (data.content.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tbody.innerHTML = data.content.map(user => `
                <tr class="hover:bg-gray-50 transition-colors border-b border-gray-50">
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-8 w-8">
                                <div class="h-8 w-8 rounded-full bg-indigo-100 flex items-center justify-center">
                                    <span class="text-indigo-600 text-sm font-medium">${user.username.charAt(0).toUpperCase()}</span>
                                </div>
                            </div>
                            <div class="ml-3">
                                <div class="text-sm font-medium text-gray-900 truncate max-w-[120px]">${user.username}</div>
                                <div class="text-xs text-gray-500">ID: ${user.id}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-xs text-gray-700 space-y-1">
                            <div class="flex items-center">
                                <i class="fas fa-phone text-indigo-500 mr-1.5 w-3"></i>
                                <span class="truncate max-w-[140px]">${user.phone || '-'}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-envelope text-indigo-500 mr-1.5 w-3"></i>
                                <span class="truncate max-w-[140px]">${user.email || '-'}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-id-card text-indigo-500 mr-1.5 w-3"></i>
                                <span class="truncate max-w-[140px]">${user.idCard ? maskIdCard(user.idCard) : '-'}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-xs text-gray-700 space-y-1">
                            <div class="flex items-center">
                                <i class="fas fa-credit-card text-green-500 mr-1.5 w-3"></i>
                                <span class="truncate max-w-[120px]">${user.bankCard ? maskBankCard(user.bankCard) : '-'}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-briefcase text-green-500 mr-1.5 w-3"></i>
                                <span class="truncate max-w-[120px]">${user.occupation || '-'}</span>
                            </div>
                            <div class="flex items-center">
                                <i class="fas fa-info-circle text-gray-400 mr-1.5 w-3"></i>
                                <span>${user.age ? user.age + 'å²' : '-'} ${user.gender ? 'Â· ' + user.gender : ''}</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap">
                        ${user.enabled
                            ? '<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">âœ“ å¯ç”¨</span>'
                            : '<span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">âœ— ç¦ç”¨</span>'
                        }
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button onclick="viewUser(${user.id})"
                                    class="text-indigo-600 hover:text-indigo-900 p-1 hover:bg-indigo-50 rounded transition-colors"
                                    title="æŸ¥çœ‹è¯¦æƒ…">
                                <i class="fas fa-eye text-sm"></i>
                            </button>
                            <button onclick="toggleUserStatus(${user.id}, ${!user.enabled})"
                                    class="text-yellow-600 hover:text-yellow-900 p-1 hover:bg-yellow-50 rounded transition-colors"
                                    title="${user.enabled ? 'ç¦ç”¨ç”¨æˆ·' : 'å¯ç”¨ç”¨æˆ·'}">
                                <i class="fas fa-${user.enabled ? 'ban' : 'check'} text-sm"></i>
                            </button>
                            <button onclick="deleteUser(${user.id})"
                                    class="text-red-600 hover:text-red-900 p-1 hover:bg-red-50 rounded transition-colors"
                                    title="åˆ é™¤ç”¨æˆ·">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // æ¸²æŸ“åˆ†é¡µæ§ä»¶
            renderPagination(data);

            // æ›´æ–°åŠ å¯†æ¼”ç¤ºæ•°æ®
            updateEncryptionDemo(data.content);
        }

        // æ¸²æŸ“åˆ†é¡µæ§ä»¶
        function renderPagination(data) {
            const pagination = document.getElementById('pagination');
            const totalPages = data.totalPages;

            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let paginationHtml = '<div class="flex flex-col sm:flex-row justify-between items-center gap-4">';
            paginationHtml += `<div class="text-sm text-gray-600 bg-gray-50 px-3 py-2 rounded-lg">æ˜¾ç¤º ${data.currentPage * data.pageSize - data.pageSize + 1} åˆ° ${Math.min(data.currentPage * data.pageSize, data.totalElements)} æ¡ï¼Œå…± ${data.totalElements} æ¡</div>`;
            paginationHtml += '<div class="flex items-center space-x-1">';

            // ä¸Šä¸€é¡µ
            if (data.currentPage > 1) {
                paginationHtml += `<button onclick="loadUsers(${data.currentPage - 1})" class="px-3 py-1.5 bg-white border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md transition-colors">Â« ä¸Šä¸€é¡µ</button>`;
            }

            // é¡µç 
            const startPage = Math.max(1, data.currentPage - 2);
            const endPage = Math.min(totalPages, data.currentPage + 2);

            for (let i = startPage; i <= endPage; i++) {
                if (i === data.currentPage) {
                    paginationHtml += `<span class="px-3 py-1.5 bg-indigo-600 text-white text-sm font-medium rounded-md">${i}</span>`;
                } else {
                    paginationHtml += `<button onclick="loadUsers(${i})" class="px-3 py-1.5 bg-white border border-gray-300 text-sm font-medium text-gray-700 hover:bg-indigo-50 hover:border-indigo-300 rounded-md transition-colors">${i}</button>`;
                }
            }

            // ä¸‹ä¸€é¡µ
            if (data.currentPage < totalPages) {
                paginationHtml += `<button onclick="loadUsers(${data.currentPage + 1})" class="px-3 py-1.5 bg-white border border-gray-300 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md transition-colors">ä¸‹ä¸€é¡µ Â»</button>`;
            }

            paginationHtml += '</div></div>';
            pagination.innerHTML = paginationHtml;
        }

        // å¤„ç†æ·»åŠ ç”¨æˆ·
        async function handleAddUser(event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const userData = Object.fromEntries(formData);

            // å¤„ç†ç©ºå€¼ - å°†ç©ºå­—ç¬¦ä¸²è½¬æ¢ä¸ºnullæˆ–undefinedï¼Œé¿å…éªŒè¯å¤±è´¥
            Object.keys(userData).forEach(key => {
                const value = userData[key];
                if (value === '' || value === null || value === undefined) {
                    // å¯¹äºéå¿…éœ€å­—æ®µï¼Œè®¾ç½®ä¸ºundefinedæˆ–åˆ é™¤
                    if (key !== 'username' && key !== 'phone') { // ç”¨æˆ·åå’Œæ‰‹æœºå·æ˜¯å¿…éœ€çš„
                        userData[key] = null;
                    }
                }
            });

            // æ‰“å°è¯·æ±‚æ•°æ®ç”¨äºè°ƒè¯•
            console.log('å‘é€çš„ç”¨æˆ·æ•°æ®:', userData);

            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                console.log('æœåŠ¡å™¨å“åº”:', result);
                console.log('å“åº”çŠ¶æ€:', response.status);

                if (result.success) {
                    showToast('ç”¨æˆ·æ·»åŠ æˆåŠŸï¼', 'success');
                    event.target.reset();
                    loadUsers();
                    loadStats();
                } else {
                    const errorMsg = result.message || 'æ·»åŠ ç”¨æˆ·å¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯';
                    showToast(errorMsg, 'error');
                    console.error('æ·»åŠ ç”¨æˆ·å¤±è´¥ï¼Œå“åº”:', result);

                    // å¦‚æœæ˜¯400é”™è¯¯ï¼Œæ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                    if (response.status === 400) {
                        console.error('400é”™è¯¯è¯¦æƒ… - å¯èƒ½çš„å­—æ®µéªŒè¯å¤±è´¥');
                        console.error('è¯·æ±‚æ•°æ®:', userData);
                    }
                }
            } catch (error) {
                console.error('æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
                console.error('è¯·æ±‚æ•°æ®:', userData);
                showToast('æ·»åŠ ç”¨æˆ·å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ‰¹é‡æ·»åŠ ç¤ºä¾‹ç”¨æˆ·
        async function addSampleUsers() {
            const sampleUsers = [
                {
                    username: 'å‰ç«¯ç”¨æˆ·å¼ ä¸‰' + Date.now(),
                    phone: '13811110001',
                    idCard: '110101199001011111',
                    email: 'frontend.zhangsan' + Date.now() + '@example.com',
                    bankCard: '6222021234567890001',
                    address: 'åŒ—äº¬å¸‚æœé˜³åŒºå»ºå›½è·¯88å·',
                    age: 25,
                    gender: 'ç”·',
                    occupation: 'å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ',
                    remark: 'å‰ç«¯ç”Ÿæˆçš„ç¤ºä¾‹ç”¨æˆ·æ•°æ®'
                },
                {
                    username: 'åç«¯ç”¨æˆ·æå››' + Date.now(),
                    phone: '13811110002',
                    idCard: '110101199002022222',
                    email: 'backend.lisi' + Date.now() + '@example.com',
                    bankCard: '6222021234567890002',
                    address: 'ä¸Šæµ·å¸‚æµ¦ä¸œæ–°åŒºé™†å®¶å˜´é‡‘èä¸­å¿ƒ',
                    age: 28,
                    gender: 'ç”·',
                    occupation: 'åç«¯å¼€å‘å·¥ç¨‹å¸ˆ',
                    remark: 'å‰ç«¯ç”Ÿæˆçš„ç¤ºä¾‹ç”¨æˆ·æ•°æ®'
                },
                {
                    username: 'æµ‹è¯•ç”¨æˆ·ç‹äº”' + Date.now(),
                    phone: '13811110003',
                    idCard: '110101199003033333',
                    email: 'test.wangwu' + Date.now() + '@example.com',
                    bankCard: '6222021234567890003',
                    address: 'å¹¿å·å¸‚å¤©æ²³åŒºç æ±Ÿæ–°åŸ',
                    age: 26,
                    gender: 'å¥³',
                    occupation: 'æµ‹è¯•å·¥ç¨‹å¸ˆ',
                    remark: 'å‰ç«¯ç”Ÿæˆçš„ç¤ºä¾‹ç”¨æˆ·æ•°æ®'
                }
            ];

            try {
                const response = await fetch(`${API_BASE}/batch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sampleUsers)
                });

                const result = await response.json();

                if (result.success) {
                    const count = result.count || result.data?.length || 0;
                    showToast(`æˆåŠŸæ·»åŠ  ${count} ä¸ªç¤ºä¾‹ç”¨æˆ·ï¼`, 'success');
                    loadUsers();
                    loadStats();
                } else {
                    const errorMsg = result.message || 'æ‰¹é‡æ·»åŠ ç”¨æˆ·å¤±è´¥ï¼ŒæœªçŸ¥é”™è¯¯';
                    showToast(errorMsg, 'error');
                    console.error('æ‰¹é‡æ·»åŠ ç”¨æˆ·å¤±è´¥ï¼Œå“åº”:', result);
                }
            } catch (error) {
                console.error('æ‰¹é‡æ·»åŠ ç”¨æˆ·å¤±è´¥:', error);
                showToast('æ‰¹é‡æ·»åŠ ç”¨æˆ·å¤±è´¥', 'error');
            }
        }

        // æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…
        async function viewUser(userId) {
            try {
                const response = await fetch(`${API_BASE}/${userId}`);
                const result = await response.json();

                if (result.success) {
                    const user = result.data;
                    const details = `
                        <div class="p-4">
                            <h4 class="font-semibold text-lg mb-3">ç”¨æˆ·è¯¦æƒ…</h4>
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div><strong>ID:</strong> ${user.id}</div>
                                <div><strong>ç”¨æˆ·å:</strong> ${user.username}</div>
                                <div><strong>æ‰‹æœºå·:</strong> ${user.phone}</div>
                                <div><strong>é‚®ç®±:</strong> ${user.email}</div>
                                <div><strong>èº«ä»½è¯:</strong> ${user.idCard}</div>
                                <div><strong>é“¶è¡Œå¡:</strong> ${user.bankCard}</div>
                                <div><strong>åœ°å€:</strong> ${user.address}</div>
                                <div><strong>å¹´é¾„:</strong> ${user.age}</div>
                                <div><strong>æ€§åˆ«:</strong> ${user.gender}</div>
                                <div><strong>èŒä¸š:</strong> ${user.occupation}</div>
                                <div><strong>çŠ¶æ€:</strong> ${user.enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}</div>
                                <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${user.createTime}</div>
                            </div>
                        </div>
                    `;
                    showToast(details, 'info', 10000);
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', error);
                showToast('æŸ¥çœ‹ç”¨æˆ·è¯¦æƒ…å¤±è´¥', 'error');
            }
        }

        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function toggleUserStatus(userId, enabled) {
            try {
                const response = await fetch(`${API_BASE}/${userId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`ç”¨æˆ·å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`, 'success');
                    loadUsers();
                    loadStats();
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
                showToast('åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥', 'error');
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showToast('ç”¨æˆ·åˆ é™¤æˆåŠŸ', 'success');
                    loadUsers();
                    loadStats();
                } else {
                    showToast(result.message, 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
                showToast('åˆ é™¤ç”¨æˆ·å¤±è´¥', 'error');
            }
        }

        // æ›´æ–°åŠ å¯†æ¼”ç¤ºæ•°æ®
        function updateEncryptionDemo(users) {
            const encryptedDiv = document.getElementById('encryptedData');
            const decryptedDiv = document.getElementById('decryptedData');

            if (users.length > 0) {
                const user = users[0];

                // è¿™é‡Œæ¼”ç¤ºåŠ å¯†å­—æ®µçš„æ¦‚å¿µï¼ˆå®é™…æ•°æ®å·²è‡ªåŠ¨è§£å¯†ï¼‰
                encryptedDiv.innerHTML = `
                    <div class="space-y-2">
                        <div><strong>æ‰‹æœºå·:</strong> ${generateMockEncryptedString(user.phone)}</div>
                        <div><strong>é‚®ç®±:</strong> ${generateMockEncryptedString(user.email)}</div>
                        <div><strong>èº«ä»½è¯:</strong> ${generateMockEncryptedString(user.idCard)}</div>
                        <div><strong>é“¶è¡Œå¡:</strong> ${generateMockEncryptedString(user.bankCard)}</div>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">* è¿™é‡Œæ˜¾ç¤ºçš„æ˜¯æ¨¡æ‹Ÿçš„åŠ å¯†æ•°æ®æ ¼å¼ï¼Œå®é™…æ•°æ®åº“ä¸­å­˜å‚¨çš„æ˜¯çœŸæ­£çš„åŠ å¯†å¯†æ–‡</p>
                `;

                decryptedDiv.innerHTML = `
                    <div class="space-y-2">
                        <div><strong>æ‰‹æœºå·:</strong> ${user.phone || '-'}</div>
                        <div><strong>é‚®ç®±:</strong> ${user.email || '-'}</div>
                        <div><strong>èº«ä»½è¯:</strong> ${user.idCard || '-'}</div>
                        <div><strong>é“¶è¡Œå¡:</strong> ${user.bankCard || '-'}</div>
                    </div>
                    <p class="text-xs text-green-600 mt-2">* ä¸šåŠ¡å±‚è‡ªåŠ¨è§£å¯†ï¼Œä»£ç æ— éœ€æ‰‹åŠ¨å¤„ç†</p>
                `;
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿçš„åŠ å¯†å­—ç¬¦ä¸²ï¼ˆç”¨äºæ¼”ç¤ºï¼‰
        function generateMockEncryptedString(text) {
            if (!text) return '-';
            // æ¨¡æ‹Ÿ Base64 ç¼–ç æ ¼å¼ï¼šiv:encrypted_data
            return `${btoa(Math.random().toString(36).substring(2, 8))}:${btoa(text).substring(0, 20)}...`;
        }

        // èº«ä»½è¯å·è„±æ•
        function maskIdCard(idCard) {
            if (!idCard || idCard.length < 18) return idCard;
            return idCard.substring(0, 6) + '********' + idCard.substring(14);
        }

        // é“¶è¡Œå¡å·è„±æ•
        function maskBankCard(bankCard) {
            if (!bankCard || bankCard.length < 8) return bankCard;
            return bankCard.substring(0, 4) + ' **** **** ' + bankCard.substring(bankCard.length - 4);
        }

        // æ˜¾ç¤º Toast é€šçŸ¥
        function showToast(message, type = 'info', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');

            const bgColors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };

            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };

            toast.className = `${bgColors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center space-x-3 slide-up`;
            toast.innerHTML = `
                <i class="fas ${icons[type]}"></i>
                <div>${message}</div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                toast.style.transition = 'all 0.3s ease-out';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 300);
            }, duration);
        }
    </script>
</body>
</html>